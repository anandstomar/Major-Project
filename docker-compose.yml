 version: '3.8'
 services:
  zookeeper:
    image: confluentinc/cp-zookeeper:7.3.0
    container_name: zookeeper
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"

  kafka:
    image: confluentinc/cp-kafka:7.3.0
    container_name: kafka
    depends_on:
      - zookeeper
    environment:
     KAFKA_BROKER_ID: 1
     KAFKA_ZOOKEEPER_CONNECT: "zookeeper:2181"
     KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
     KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
     KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:29092,PLAINTEXT_HOST://0.0.0.0:9092
     KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
    #  KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT
    #  KAFKA_LISTENERS: INTERNAL://0.0.0.0:29092,EXTERNAL://0.0.0.0:9092
    #  KAFKA_ADVERTISED_LISTENERS: INTERNAL://kafka:29092,EXTERNAL://172.18.0.1:9092
    #  KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL
     KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    ports:
     - "9092:9092"
     - "29092:29092"

    # environment:
    #   KAFKA_BROKER_ID: 1
    #   KAFKA_ZOOKEEPER_CONNECT: "zookeeper:2181"
      
    #   # Map: Define two protocols, INTERNAL and EXTERNAL
    #   KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT
    #   KAFKA_LISTENERS: INTERNAL://0.0.0.0:29092,EXTERNAL://0.0.0.0:9092
    #   KAFKA_ADVERTISED_LISTENERS: INTERNAL://kafka:29092,EXTERNAL://192.168.1.6:9092      
    #   KAFKA_INTER_BROKER_LISTENER_NAME: INTERNAL
    #   KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    # ports:
    #   - "9092:9092"

    

  minio:
    image: minio/minio:RELEASE.2024-01-16T16-07-38Z
    container_name: minio
    command: server /data --console-address ":9001"
    environment:
      MINIO_ROOT_USER: minioadmin
      MINIO_ROOT_PASSWORD: minioadmin
    ports:
      - "9000:9000" # API Port
      - "9001:9001" # Console UI Port
    volumes:
      - minio-data:/data

  ipfs:
    image: ipfs/kubo:latest
    container_name: ipfs
    ports:
      - "4001:4001" # Swarm
      - "5001:5001" # API
      - "8080:8080" # Gateway
    volumes:
      - ipfs-data:/data/ipfs
    environment:
      - IPFS_PROFILE=server

  kafkaui:
    image: provectuslabs/kafka-ui:latest
    container_name: kafkaui
    depends_on:
      - kafka
    environment:
      KAFKA_CLUSTERS_0_NAME: "local"
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: "kafka:29092" 
      KAFKA_CLUSTERS_0_ZOOKEEPER: "zookeeper:2181"
    ports:
      - "8081:8080"

  postgres:
    image: postgres:15
    container_name: postgres
    environment:
      POSTGRES_DB: indexer
      POSTGRES_USER: indexer
      POSTGRES_PASSWORD: indexerpwd
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data

  opensearch:
    image: opensearchproject/opensearch:2.6.0
    container_name: opensearch
    environment:
      - discovery.type=single-node
      # Disabling security plugin for easier local development (no HTTPS/Auth required)
      - plugins.security.disabled=true 
      # Optional: Set heap size if your machine is low on RAM
      - "OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    ports:
      - "9200:9200"
      - "9600:9600"
    volumes:
      - opensearch-data:/usr/share/opensearch/data

 

  mailhog:
    image: mailhog/mailhog:latest
    ports:
      - "1025:1025" # smtp
      - "8025:8025" # ui

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"

  auditor-verifier:
    build: ./services/auditor-verifier
    container_name: auditor-verifier
    depends_on:
      - kafka
      - minio
    environment:
      - KAFKA_BROKER=kafka:29092
      - MINIO_ENDPOINT=minio
      - MINIO_PORT=9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
      - INPUT_TOPIC=anchors.completed
      - OUTPUT_TOPIC=anchors.verified

  ingest-service:
    build: ./services/ingest-service
    container_name: ingest-service
    depends_on:
      - kafka
      - minio
    environment:
      - KAFKA_BROKER=kafka:29092
      - PORT=3000
      - KAFKA_TOPIC=ingest.events
      # These must be aligned with the lines above
      - MINIO_ENDPOINT=minio
      - MINIO_PORT=9000
      - MINIO_ACCESS_KEY=minioadmin
      - MINIO_SECRET_KEY=minioadmin
      - MINIO_USE_SSL=false # Implicitly joins the default network with everyone else
  
  query-service:
    build: ./services/query-service
    container_name: query-service
    environment:
      - PORT=3000
    networks:
      - default

  notification-service:
    build: ./services/notification-service
    container_name: notification-service
    depends_on:
      - kafka
      - redis
      - mailhog
    environment:
      - PORT=3000
      # Kafka Config
      - KAFKA_BROKERS=kafka:29092
      - KAFKA_GROUP_ID=notification-group
      - KAFKA_TOPIC=anchors.completed
      
      # Redis Config (Points to container 'redis')
      - REDIS_URL=redis://redis:6379
      
      # MailHog Config (Points to container 'mailhog')
      - SMTP_HOST=mailhog
      - SMTP_PORT=1025
      - EMAIL_FROM=system@blockchain.local
      - NOTIFY_EMAIL_TO=admin@blockchain.local
    networks:
      - default

  edge-proxy:
    build: ./services/edge-proxy
    ports:
      - "8085:8085" 
    depends_on:
      - notification-service
      # - auditor-verifier
      - ingest-service
      - query-service
  
  

  solana:
    image: solanalabs/solana:v1.18.15
    ports:
      - "8899:8899"             # RPC
      - "8900:8900"             # WebSocket
      - "8000-8020:8000-8020/udp" # Gossip & TPU (UDP) - Critical
      - "8000-8020:8000-8020/tcp" # Gossip & TPU (TCP)
    command: >
      solana-test-validator 
      --reset 
      --quiet 
      --rpc-bind-address 0.0.0.0      # Listen for RPC on all container interfaces
      --bind-address 0.0.0.0          # Listen for UDP/Gossip on all container interfaces
      --gossip-host 127.0.0.1         # ADVERTISE 127.0.0.1 to the Windows client
      --gossip-port 8001              # Explicitly set gossip port
      --tpu-port 8003                 # Explicitly set TPU port
    healthcheck:
      test: ["CMD", "solana", "gossip"]
      interval: 10s
      retries: 5
    
   

 volumes:
  minio-data:
  ipfs-data:
  postgres-data:    
  opensearch-data:  


