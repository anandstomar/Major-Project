name: CD - Update Helm Values

on:
  workflow_run:
    workflows: ["CI - build & push images"]
    types:
      - completed

permissions:
  contents: write

jobs:
  update-helm:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GHCRPAT }}

      - name: Download Image Manifest
        uses: actions/download-artifact@v4
        with:
          name: image-manifest
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GHCRPAT }}

      - name: Install yq
        run: |
          wget -qO /usr/local/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          chmod +x /usr/local/bin/yq

      - name: Update Helm Values
        run: |
          MANIFEST="image-manifest.json"
          cat $MANIFEST
          
          # Iterate over each service in the JSON
          for svc in $(jq -r 'keys[]' $MANIFEST); do
            image=$(jq -r --arg k "$svc" '.[$k]' $MANIFEST)
            
            # Extract Tag (everything after the colon)
            TAG="${image##*:}"
            
            # Define path to values.yaml
            VALUES_FILE="infra/helm-charts/${svc}/values.yaml"
            
            if [ -f "$VALUES_FILE" ]; then
              echo "Updating $svc in $VALUES_FILE to tag: $TAG"
              # Update the tag in values.yaml (assumes standard Helm structure)
              yq -i ".image.tag = \"$TAG\"" "$VALUES_FILE"
              yq -i ".image.repository = \"${image%%:*}\"" "$VALUES_FILE"
            else
              echo "Warning: $VALUES_FILE not found."
            fi
          done

      - name: Commit and Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add infra/helm-charts
          git commit -m "chore(cd): update image tags [skip ci]" || echo "No changes to commit"
          git push